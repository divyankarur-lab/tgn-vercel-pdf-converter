<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>TGN Agreement PDF Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 0; 
            padding: 20px; 
            background: #f5f5f5; 
        }
        .generator-container { 
            max-width: 800px; 
            margin: 0 auto; 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }
        .status { 
            padding: 10px; 
            border-radius: 4px; 
            margin: 10px 0; 
            text-align: center;
        }
        .loading { background: #e3f2fd; color: #1976d2; }
        .success { background: #e8f5e8; color: #2e7d32; }
        .error { background: #ffebee; color: #c62828; }
        #content { 
            border: 5px solid #34C759; 
            padding: 40px; 
            margin: 20px 0;
            background: white;
            font-family: Arial, sans-serif;
        }
        #content img { 
            width: 100px; 
            height: auto; 
            display: block; 
            margin: 0 auto 20px;
        }
        #content h1 { 
            text-align: center; 
            font-size: 40px; 
            color: #1c1c1c; 
            margin: 0 0 20px 0;
        }
        #content .goodwill { color: #34C759; }
        #content hr { 
            border: 0; 
            height: 1px; 
            background: #e0e5ec; 
            margin: 20px 0; 
        }
        #content p { 
            font-size: 18px; 
            line-height: 1.5; 
            margin: 15px 0;
        }
        button {
            background: #34C759;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover { background: #2da94b; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .input-group {
            margin: 20px 0;
        }
        label {
            display: block;
            margin: 10px 0 5px 0;
            font-weight: bold;
        }
        input, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        textarea {
            height: 100px;
            resize: vertical;
        }
    </style>
</head>
<body>
    <div class="generator-container">
        <h1>üìÑ TGN Agreement PDF Generator</h1>
        <div id="status" class="status loading">‚úÖ Ready to generate PDF</div>
        
        <div class="input-group">
            <label for="freelancerName">Freelancer Name:</label>
            <input type="text" id="freelancerName" value="John Smith" placeholder="Enter freelancer name">
        </div>
        
        <div class="input-group">
            <label for="producerName">Producer Name:</label>
            <input type="text" id="producerName" value="Jane Producer" placeholder="Enter producer name">
        </div>
        
        <div class="input-group">
            <label for="projectDetails">Project Details:</label>
            <textarea id="projectDetails" placeholder="Enter project details (optional)">Web development project for e-commerce platform including frontend and backend development.</textarea>
        </div>
        
        <button onclick="generatePDF()" id="generateBtn">üìÑ Generate PDF</button>
        <button onclick="updatePreview()" id="previewBtn">üëÄ Update Preview</button>
        <button onclick="generatePDFNoImages()" id="testBtn" style="background: #ff6b6b;">üß™ Test PDF (No Images)</button>
        
        <div id="content">
            <img src="https://ik.imagekit.io/divyankarur/o__2_-removebg-preview.png?updatedAt=1755246312760" alt="TGN Logo">
            <h1>the <span class="goodwill">goodwill</span> agreement</h1>
            <hr>
            <p><strong>Freelancer:</strong> <span id="preview-freelancer">John Smith</span></p>
            <p><strong>Producer:</strong> <span id="preview-producer">Jane Producer</span></p>
            <p><strong>Project:</strong> <span id="preview-project">Web development project for e-commerce platform including frontend and backend development.</span></p>
            <hr>
            <p>This Agreement establishes the terms and conditions for collaboration between the above parties in accordance with The Good Will Network's principles of mutual respect, fair compensation, and professional excellence.</p>
            <p>Both parties agree to maintain open communication, deliver quality work, and uphold the values of integrity and goodwill throughout the project duration.</p>
        </div>
    </div>

    <script>
        // Update preview with form data
        function updatePreview() {
            document.getElementById('preview-freelancer').textContent = 
                document.getElementById('freelancerName').value || 'Freelancer Name';
            document.getElementById('preview-producer').textContent = 
                document.getElementById('producerName').value || 'Producer Name';  
            document.getElementById('preview-project').textContent = 
                document.getElementById('projectDetails').value || 'Project details to be specified';
        }

        // Generate PDF function - SIMPLIFIED APPROACH
        async function generatePDF() {
            try {
                document.getElementById('status').innerHTML = 'üîÑ Generating PDF...';
                document.getElementById('status').className = 'status loading';
                document.getElementById('generateBtn').disabled = true;
                
                // Update preview first
                updatePreview();
                
                // Wait a moment for preview to update
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Get the content div directly (no cloning!)
                const contentDiv = document.getElementById('content');
                
                // Wait for all images to be fully loaded
                const images = contentDiv.querySelectorAll('img');
                console.log('Found images:', images.length);
                
                for (let img of images) {
                    if (!img.complete) {
                        console.log('Waiting for image to load:', img.src);
                        await new Promise((resolve) => {
                            img.onload = resolve;
                            img.onerror = resolve;
                            setTimeout(resolve, 3000); // Max 3 second wait per image
                        });
                    }
                }
                
                console.log('All images loaded, generating PDF...');
                
                // Simple PDF options - minimal configuration
                const options = {
                    margin: 0.5, // inches
                    filename: 'goodwill-agreement.pdf',
                    image: { type: 'jpeg', quality: 1.0 },
                    html2canvas: { 
                        scale: 2,
                        useCORS: true,
                        logging: true,
                        allowTaint: true
                    },
                    jsPDF: { 
                        unit: 'in', 
                        format: 'a4', 
                        orientation: 'portrait' 
                    }
                };
                
                // Generate PDF directly from visible content
                console.log('Starting PDF generation...');
                await html2pdf().set(options).from(contentDiv).save();
                console.log('PDF generation completed!');
                
                document.getElementById('status').innerHTML = 'üéâ PDF generated and downloaded successfully!';
                document.getElementById('status').className = 'status success';
                document.getElementById('generateBtn').disabled = false;
                
            } catch (error) {
                console.error('PDF generation error:', error);
                document.getElementById('status').innerHTML = '‚ùå Error: ' + error.message;
                document.getElementById('status').className = 'status error';
                document.getElementById('generateBtn').disabled = false;
            }
        }
        
        // Debug function to test without images
        async function generatePDFNoImages() {
            try {
                document.getElementById('status').innerHTML = 'üîÑ Generating PDF (text only)...';
                document.getElementById('status').className = 'status loading';
                
                // Create a simple test div
                const testDiv = document.createElement('div');
                testDiv.innerHTML = `
                    <div style="border: 5px solid #34C759; padding: 40px; font-family: Arial;">
                        <h1 style="text-align: center; font-size: 40px;">TEST AGREEMENT</h1>
                        <hr style="border: 0; height: 1px; background: #ccc; margin: 20px 0;">
                        <p style="font-size: 18px;">This is a test PDF without images.</p>
                        <p style="font-size: 18px;">Freelancer: ${document.getElementById('freelancerName').value}</p>
                        <p style="font-size: 18px;">Producer: ${document.getElementById('producerName').value}</p>
                    </div>
                `;
                testDiv.style.position = 'absolute';
                testDiv.style.top = '-9999px';
                document.body.appendChild(testDiv);
                
                await html2pdf().from(testDiv).save('test-agreement.pdf');
                
                document.body.removeChild(testDiv);
                document.getElementById('status').innerHTML = 'üéâ Test PDF generated!';
                document.getElementById('status').className = 'status success';
                
            } catch (error) {
                document.getElementById('status').innerHTML = '‚ùå Test failed: ' + error.message;
                document.getElementById('status').className = 'status error';
            }
        }

        // Auto-update preview when typing
        document.getElementById('freelancerName').addEventListener('input', updatePreview);
        document.getElementById('producerName').addEventListener('input', updatePreview);
        document.getElementById('projectDetails').addEventListener('input', updatePreview);
        
        // Initialize preview
        updatePreview();
    </script>
</body>
</html>